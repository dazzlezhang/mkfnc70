#!/bin/bash
#
# mkfnc70 -- make Type 1 subfonts and auxiliary files for CJK
# package (UTF-8)
#
# (C) Copyright 2011 Yu Zhang <yu_zhang@ieee.org>
#

VERSION="1.0"
FILEDATE="2011/12/23"

E_BADARGS=65
E_BADFILE=127

EXPECTED_ARGS=1
FILE=$1

function welcome() {
    echo "This is mkfnc70, Version" $VERSION "("$FILEDATE")"
}

function usage() {
    echo "Usage: `basename $0` FILE
Generate Type 1 subfonts for CJK package (UTF-8).

The FILE describes foundry, family, and the path to the TrueType 
font. See \$PREFIX/mkfnc70/fontlist.example for details.

Report bugs to <yu_zhang@ieee.org>." >&2
}

function check_file() {
    TARGET=$1
    SOURCE=$2

    if [ ! $SOURCE ]
    then
	echo "File not found - " $TARGET
	exit $E_BADFILE
    fi
}

function configure() {
    DIRNAME=$1

    TARGET="fontforge"
    FONTFORGE=`which $TARGET`
    check_file $TARGET $FONTFORGE

    TARGET="perl"
    PERL=`which perl`
    check_file $TARGET $PERL

    TARGET="awk"
    AWK=`which $TARGET`
    check_file $TARGET $AWK

    TARGET="kpsewhich"
    KPSEWHICH=`which $TARGET`
    check_file $TARGET $KPSEWHICH

    TARGET="Unicode.sfd"
    UNICODE_SFD=`kpsewhich $TARGET`
    check_file $TARGET $UNICODE_SFD

    TARGET="subfonts.pe"
    SUBFONTS_PE=`find /usr -name $TARGET`
    check_file $TARGET $SUBFONTS_PE

    TARGET="vertref.pe"
    VERTREF_PE=`find /usr -name $TARGET`
    check_file $TARGET $VERTREF_PE

    TARGET="makefdx.pl"
    MAKEFDX_PL=`find /usr -name $TARGET`
    check_file $TARGET $MAKEFDX_PL

    TARGET="aglfn13.txt"
    AGLFN13_TXT=$DIRNAME/helper/$TARGET
    check_file $TARGET $AGLFN13_TXT

    TARGET="mkfnc70.awk"
    MKFNC70_AWK=$DIRNAME/helper/$TARGET
    check_file $TARGET $MKFNC70_AWK

    ln -fs $UNICODE_SFD Unicode.sfd
    ln -fs $SUBFONTS_PE subfonts.pe
    ln -fs $VERTREF_PE  vertref.pe
    ln -fs $MAKEFDX_PL  makefdx.pl
    ln -fs $AGLFN13_TXT aglfn13.txt
    ln -fs $MKFNC70_AWK mkfnc70.awk

    TEXMF=./texmf
    if [ -d "$TEXMF" ]
    then
	rm -rf $TEXMF
    fi

    INSTALL=./install
    if [ -f "$INSTALL" ]
    then
	rm -rf $INSTALL
    fi

    echo ""
}

function build() {
    FONTLIST=$FILE
    SCRIPT=script
    touch $SCRIPT
    chmod 755 $SCRIPT
    awk -f $MKFNC70_AWK $FONTLIST > $SCRIPT
    ./SCRIPT
}

function clean() {
    rm -f Unicode.sfd
    rm -f subfonts.pe
    rm -f vertref.pe
    rm -f makefdx.pl
}

function install() { 
    cat >> install << EOF
# !/bin/bash
#
# This is the install script generated by mkfnc70.
#
# Report bugs to <yu_zhang@ieee.org> 

echo "This is the installation script generated by mkfnc70. 
All files and directories under ./texmf will be installed to
TEXMFHOME."

read -p "Are you sure you want to continue with the installation \
process (y/n)?" -n 1
if [[ \$REPLY =~ ^[Yy] ]]
then
    cp -r texmf/* \`kpsewhich -var-value TEXMFHOME\`
    MAPPATH=\`ls -R texmf/fonts/map/dvips/*/*.map\`
    MAPFILE=\`basename \$MAPPATH\`
    for i in $MAPFILE
    do 
        updmap --nomkmap --nohash --enable Map=\$i
    done
    updmap
else
    echo ""
    echo "The generated Type 1 subfonts are not installed."
fi
EOF
    chmod 755 ./install
    echo "
Congratulations! 

Type 1 subfonts and auxiliary files are ready. Run \`./install' to
install the generated fonts to your \$TEXMFHOME."  
}

# Main part

if [ $# -ne $EXPECTED_ARGS ]
then
    usage
    exit $E_BADARGS
fi

if [ ! -f $FILE ]
then
    echo "File not found!"
    exit $E_BADARGS
fi

welcome
configure `dirname $0`
build
clean
install